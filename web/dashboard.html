<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>System Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root { --bg:#0b0d12; --panel:#131722; --text:#e6edf3; --muted:#9aa4b2; --accent:#4da3ff; }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
        header{display:flex;gap:16px;align-items:center;padding:14px 18px;border-bottom:1px solid #1d2433;background:linear-gradient(180deg,#121826,#0b0d12)}
        header h1{font-size:16px;margin:0;font-weight:600}
        .controls{display:flex;flex-wrap:wrap;gap:10px;margin-left:auto}
        .controls > *{background:var(--panel);border:1px solid #1e2635;color:var(--text);padding:8px 10px;border-radius:10px}
        .controls input[type="text"], .controls select{min-width:140px}
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;padding:14px}
        .card{grid-column:span 12;background:var(--panel);border:1px solid #1d2433;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
        .card header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:0;border-bottom:1px solid #1d2433;background:transparent}
        .card h2{margin:0;font-size:14px;color:#d3d9e3;font-weight:600}
        .card .canvas-wrap{padding:12px}
        @media (min-width:900px){
            .span-6{grid-column:span 6}
            .span-4{grid-column:span 4}
        }
        .kpi{display:flex;gap:18px;flex-wrap:wrap;padding:10px 12px}
        .kpi .pill{background:#0e1320;border:1px solid #1d2433;padding:8px 10px;border-radius:999px;color:var(--muted)}
        a{color:var(--accent);text-decoration:none}
    </style>
</head>
<body>
<header>
    <h1>System Monitoring Dashboard</h1>
    <div class="controls">
        <input id="baseUrl" type="text" placeholder="http://<host>:8080" />
        <select id="preset">
            <option value="60">Last 60s</option>
            <option value="300">Last 5m</option>
            <option value="900">Last 15m</option>
            <option value="3600">Last 1h</option>
        </select>
        <input id="iface" type="text" placeholder="iface (e.g., ens33)" />
        <button id="refresh">Refresh</button>
        <label style="display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;background:var(--panel);border:1px solid #1e2635"><input id="autorefresh" type="checkbox" checked /> Auto-refresh</label>
    </div>
</header>

<div class="grid">

    <section class="card span-6" id="card-cpu-total">
        <header><h2>CPU — Total Usage (%)</h2></header>
        <div class="kpi" id="kpi-cpu"></div>
        <div class="canvas-wrap"><canvas id="chartCpu"></canvas></div>
    </section>

    <section class="card span-6" id="card-mem">
        <header><h2>Memory — Used (bytes)</h2></header>
        <div class="kpi" id="kpi-mem"></div>
        <div class="canvas-wrap"><canvas id="chartMem"></canvas></div>
    </section>

    <section class="card span-6" id="card-net">
        <header><h2>Network — Throughput (bytes/sec)</h2></header>
        <div class="kpi" id="kpi-net"></div>
        <div class="canvas-wrap"><canvas id="chartNet"></canvas></div>
    </section>

    <section class="card span-6" id="card-disk">
        <header><h2>Disk I/O — Read/Write (bytes/sec)</h2></header>
        <div class="kpi" id="kpi-disk"></div>
        <div class="canvas-wrap"><canvas id="chartDisk"></canvas></div>
    </section>

</div>

<script>
    (function(){
        // --- Config ---
        const $ = (q) => document.querySelector(q);
        const baseUrlInput = $('#baseUrl');
        const presetSel    = $('#preset');
        const ifaceInput   = $('#iface');
        const autoRefresh  = $('#autorefresh');
        const refreshBtn   = $('#refresh');

        // Try to infer base URL from current location; fallback to sample
        const defaultBase = location.port ? `${location.protocol}//${location.host}` : 'http://192.168.73.142:8080';
        baseUrlInput.value = defaultBase;
        ifaceInput.value   = 'ens33';

        // --- Chart helpers ---
        const makeChart = (ctx, label) => new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label, data: [], tension: .25, borderWidth: 2, pointRadius: 0 }] },
            options: {
                responsive: true,
                animation: false,
                scales: { x: { ticks: { color:'#9aa4b2', maxRotation:0 }, grid:{ color:'#1d2433' }},
                    y: { ticks: { color:'#9aa4b2' }, grid:{ color:'#1d2433' } } },
                plugins: { legend: { labels:{ color:'#d6dbe3' } }, tooltip: { mode:'index', intersect:false } }
            }
        });

        const ctxCpu  = document.getElementById('chartCpu');
        const ctxMem  = document.getElementById('chartMem');
        const ctxNet  = document.getElementById('chartNet');
        const ctxDisk = document.getElementById('chartDisk');

        const chartCpu  = makeChart(ctxCpu,  'cpu.total_pct');
        const chartMem  = makeChart(ctxMem,  'mem.used_bytes');
        const chartNet  = new Chart(ctxNet, {
            type:'line',
            data:{ labels:[], datasets:[
                    { label:'net.rx_bytes', data:[], tension:.25, borderWidth:2, pointRadius:0 },
                    { label:'net.tx_bytes', data:[], tension:.25, borderWidth:2, pointRadius:0 }
                ]},
            options:{ responsive:true, animation:false, scales:{ x:{ ticks:{color:'#9aa4b2'}, grid:{color:'#1d2433'} }, y:{ ticks:{color:'#9aa4b2'}, grid:{color:'#1d2433'} } }, plugins:{ legend:{ labels:{ color:'#d6dbe3' }}}}
        });
        const chartDisk = new Chart(ctxDisk, {
            type:'line', data:{ labels:[], datasets:[
                    { label:'disk.read_bytes', data:[], tension:.25, borderWidth:2, pointRadius:0 },
                    { label:'disk.write_bytes', data:[], tension:.25, borderWidth:2, pointRadius:0 }
                ]}, options:{ responsive:true, animation:false, scales:{ x:{ ticks:{color:'#9aa4b2'}, grid:{color:'#1d2433'} }, y:{ ticks:{color:'#9aa4b2'}, grid:{color:'#1d2433'} } }, plugins:{ legend:{ labels:{ color:'#d6dbe3' }}}}
        });

        // --- API helpers ---
        const q = (obj) => Object.entries(obj).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
        const nowMs = () => Date.now();

        async function fetchTS(metric, seconds, labelsKV) {
            const to = nowMs();
            const from = to - (seconds * 1000);
            const labels = labelsKV && Object.keys(labelsKV).length ? q({ labels: Object.entries(labelsKV).map(([k,v])=>`${k}:${v}`).join(',') }) : '';
            const url = `${baseUrlInput.value}/api/timeseries?metric=${encodeURIComponent(metric)}&from=${from}&to=${to}${labels?`&${labels}`:''}`;
            const r = await fetch(url);
            if(!r.ok) throw new Error(await r.text());
            return r.json();
        }

        function setSeries(chart, labels, values) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = values;
            chart.update();
        }
        function setTwoSeries(chart, labels, v1, v2){
            chart.data.labels = labels;
            chart.data.datasets[0].data = v1;
            chart.data.datasets[1].data = v2;
            chart.update();
        }
        function fmtBytes(n){
            const units=['B','KB','MB','GB','TB'];
            let u=0, x=n;
            while(x>=1024 && u<units.length-1){ x/=1024; u++; }
            return `${x.toFixed(1)} ${units[u]}`;
        }

        function unwrapSamples(resp) {
            // single-series
            if (resp && Array.isArray(resp.samples)) return resp.samples;

            // multi-series -> sum by timestamp
            if (resp && Array.isArray(resp.series)) {
                const sum = new Map(); // t -> total
                for (const s of resp.series) {
                    for (const [t, v] of (s.samples || [])) {
                        sum.set(t, (sum.get(t) || 0) + (Number(v) || 0));
                    }
                }
                return Array.from(sum.entries()).sort((a,b)=>a[0]-b[0]);
            }
            return [];
        }


        async function refreshAll(){
            const seconds = parseInt(presetSel.value,10);
            const iface = ifaceInput.value.trim();

            // CPU total
            try {
                const j = await fetchTS('cpu.total_pct', seconds);
                const lbl = j.samples.map(s=>new Date(s[0]).toLocaleTimeString());
                const val = j.samples.map(s=>s[1]);
                setSeries(chartCpu, lbl, val);
                const last = val.at(-1) ?? 0;
                document.getElementById('kpi-cpu').innerHTML = `<span class="pill">Latest: ${last.toFixed(1)} %</span>`;
            } catch(e){ console.warn('cpu', e); }

            // Memory used
            try {
                const j = await fetchTS('mem.used_bytes', seconds);
                const lbl = j.samples.map(s=>new Date(s[0]).toLocaleTimeString());
                const val = j.samples.map(s=>s[1]);
                setSeries(chartMem, lbl, val);
                const last = val.at(-1) ?? 0;
                document.getElementById('kpi-mem').innerHTML = `<span class="pill">Latest: ${fmtBytes(last)}</span>`;
            } catch(e){ console.warn('mem', e); }

            // Network (bytes/sec) — requires iface label
            try {
                const labelsKV = iface ? { iface } : {};
                const rx = await fetchTS('net.rx_bytes', seconds, labelsKV);
                const tx = await fetchTS('net.tx_bytes', seconds, labelsKV);
                const lbl = rx.samples.map(s=>new Date(s[0]).toLocaleTimeString());
                const v1  = rx.samples.map(s=>s[1]);
                const v2  = tx.samples.map(s=>s[1]);
                setTwoSeries(chartNet, lbl, v1, v2);
                const l1=v1.at(-1)||0, l2=v2.at(-1)||0;
                document.getElementById('kpi-net').innerHTML = `<span class="pill">RX: ${fmtBytes(l1)}/s</span><span class="pill">TX: ${fmtBytes(l2)}/s</span>`;
            } catch(e){ console.warn('net', e); }

            // Disk (bytes/sec) — aggregated over all devs by summing client-side
            try {
                const r = await fetchTS('disk.read_bytes',  seconds);
                const w = await fetchTS('disk.write_bytes', seconds);

                const rs = unwrapSamples(r);
                const ws = unwrapSamples(w);

                const lbl = rs.map(([t]) => new Date(t).toLocaleTimeString());
                const v1  = rs.map(([_,v]) => v);
                const v2  = ws.map(([_,v]) => v);

                setTwoSeries(chartDisk, lbl, v1, v2);

                const l1=v1.at(-1)||0, l2=v2.at(-1)||0;
                document.getElementById('kpi-disk').innerHTML =
                    `<span class="pill">Read: ${fmtBytes(l1)}/s</span>` +
                    `<span class="pill">Write: ${fmtBytes(l2)}/s</span>`;
            } catch(e){ console.warn('disk', e); }

        }

        // Auto refresh
        let timer=null;
        function start(){ if(timer) clearInterval(timer); if(autoRefresh.checked){ timer=setInterval(refreshAll, 2000); } }

        refreshBtn.addEventListener('click', refreshAll);
        autoRefresh.addEventListener('change', start);
        presetSel.addEventListener('change', refreshAll);
        baseUrlInput.addEventListener('change', refreshAll);
        ifaceInput.addEventListener('change', refreshAll);

        // Initial load
        refreshAll();
        start();
    })();
</script>
</body>
</html>
